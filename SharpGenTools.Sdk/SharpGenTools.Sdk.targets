<Project>
  <PropertyGroup>
    <SharpGenGeneratedCodeFolder Condition="'$(SharpGenGeneratedCodeFolder)' == ''">$(IntermediateOutputPath)/SharpGen</SharpGenGeneratedCodeFolder>
    <SharpGenConsumerBindMappingFilePrefix Condition="'$(SharpGenConsumerBindMappingFilePrefix)' == ''">$(AssemblyName).$(TargetFramework)</SharpGenConsumerBindMappingFilePrefix>
    <SharpGenConsumerBindMappingConfigId Condition="'$(SharpGenConsumerBindMappingConfigId)' == ''">$(AssemblyName)</SharpGenConsumerBindMappingConfigId>
    <SharpGenSdkAssembly Condition="'$(MSBuildRuntimeType)' == 'Full'">$(MSBuildThisFileDirectory)/../tools/net46/SharpGenTools.Sdk.dll</SharpGenSdkAssembly>
    <SharpGenSdkAssembly Condition="'$(MSBuildRuntimeType)' == 'Core'">$(MSBuildThisFileDirectory)/../tools/netstandard1.5/SharpGenTools.Sdk.dll</SharpGenSdkAssembly>
  </PropertyGroup>

  <UsingTask AssemblyFile="$(SharpGenSdkAssembly)" TaskName="SharpPatchTask" />
  <UsingTask AssemblyFile="$(SharpGenSdkAssembly)" TaskName="SharpGenTask" />

  <Target Name="GetMappingsFromProjectReferences">
    <MSBuild
      Projects="@(_MSBuildProjectReferenceExistent)"
      Targets="GenerateConsumerBindMappingFile"
      BuildInParallel="$(BuildInParallel)"
      Properties="%(_MSBuildProjectReferenceExistent.SetConfiguration); %(_MSBuildProjectReferenceExistent.SetPlatform); %(_MSBuildProjectReferenceExistent.SetTargetFramework)"
      ContinueOnError="$(ContinueOnError)"
      RemoveProperties="%(_MSBuildProjectReferenceExistent.GlobalPropertiesToRemove)">
      <Output TaskParameter="TargetOutputs" ItemName="SharpGenMapping" />
    </MSBuild>
  </Target>
  
  <Target
    Name="CorePrepareSharpGen"
    DependsOnTargets="GetMappingsFromProjectReferences">
    <ItemGroup>
      <Compile Remove="$(IntermediateOutputPath)/SharpGen/**/*.cs" />
      <SharpGenGeneratedSource Include="$(IntermediateOutputPath)/SharpGen/**/*.cs" />
      <SharpGenConsumerBindMappingFile Include="$(MSBuildProjectDirectory)/$(IntermediateOutputPath)SharpGen/$(SharpGenConsumerBindMappingFilePrefix).BindMapping.xml" />
    </ItemGroup>
  </Target>

  <Target
    Name="GenerateSharpGenBindings"
    BeforeTargets="CoreCompile"
    DependsOnTargets="PrepareForBuild;CoreGenerateSharpGenBindings;GenerateConsumerBindMappingFile"
    />

  <Target
    Name="CoreGenerateSharpGenBindings" 
    BeforeTargets="CoreCompile"
    DependsOnTargets="PrepareForBuild;CorePrepareSharpGen"
    Inputs="@(SharpGenMapping);$(SharpGenSdkAssembly)"
    Outputs="@(SharpGenConsumerBindMappingFile);@(SharpGenGeneratedSource)">

    <MakeDir Directories="$(IntermediateOutputPath)/SharpGen" />
    <SharpGenTask
      CastXmlPath="$(CastXmlPath)"
      AppTypes="$(SharpGenAppType)"
      GenerateDocs="$(SharpGenGenerateDoc)"
      GlobalNamespace="$(SharpGenGlobalNamespace)"
      VcToolsPath="$(VCToolsDir)"
      MappingFiles="@(SharpGenMapping)"
      IntermediateOutputPath="$(MSBuildProjectDirectory)\$(IntermediateOutputPath)SharpGen"
      GeneratedCodeFolder="$(SharpGenGeneratedCodeFolder)"
      IncludeAssemblyNameFolder="$(SharpGenIncludeAssemblyNameFolder)"
      OutputDirectory="$(MSBuildProjectDirectory)"
      ConsumerBindMappingFilePrefix="$(SharpGenConsumerBindMappingFilePrefix)"
      ConsumerBindMappingConfigId ="$(SharpGenConsumerBindMappingConfigId)"
    />

    <ItemGroup>
      <Compile Include="$(IntermediateOutputPath)/SharpGen/**/*.cs" />
    </ItemGroup>
  </Target>

  <Target
    Name="GenerateConsumerBindMappingFile"
    DependsOnTargets="CoreGenerateSharpGenBindings"
    Outputs="@(SharpGenConsumerBindMappingFile)"
  >
  </Target>
  
  <Target Name="CleanSharpGenBindings" BeforeTargets="Clean">
    <RemoveDir Directories="$(BaseIntermediateOutputPath)/**/SharpGen" />
  </Target>
  
  <Target
    Name="PatchAssembly"
    DependsOnTargets="CoreCompile"
    BeforeTargets="CopyFilesToOutputDirectory"
    Inputs="@(IntermediateAssembly)"
    Outputs="@(IntermediateAssembly->'%(FullPath).check')"
  >
    <SharpPatchTask AssemblyToPatch="%(IntermediateAssembly.FullPath)" References="@(ReferencePath)" />
  </Target>
</Project>