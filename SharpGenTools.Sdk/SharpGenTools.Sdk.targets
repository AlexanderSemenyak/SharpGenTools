<Project>
  <PropertyGroup>
    <SharpGenGeneratedCodeFolder Condition="'$(SharpGenGeneratedCodeFolder)' == ''">$(IntermediateOutputPath)/SharpGen</SharpGenGeneratedCodeFolder>
    <SharpGenConsumerBindMappingFilePrefix Condition="'$(SharpGenConsumerBindMappingFilePrefix)' == ''">$(MSBuildProjectName).$(TargetFramework)</SharpGenConsumerBindMappingFilePrefix>
  </PropertyGroup>

  <UsingTask Condition="'$(MSBuildRuntimeType)' == 'Full'" AssemblyFile="../tools/net46/SharpGenTools.Sdk.dll" TaskName="SharpPatchTask" />
  <UsingTask Condition="'$(MSBuildRuntimeType)' == 'Full'" AssemblyFile="../tools/net46/SharpGenTools.Sdk.dll" TaskName="SharpGenTask" />
  <UsingTask Condition="'$(MSBuildRuntimeType)' == 'Core'" AssemblyFile="../tools/netstandard1.5/SharpGenTools.Sdk.dll" TaskName="SharpPatchTask" />
  <UsingTask Condition="'$(MSBuildRuntimeType)' == 'Core'" AssemblyFile="../tools/netstandard1.5/SharpGenTools.Sdk.dll" TaskName="SharpGenTask" />
  
  <Target Name="CorePrepareSharpGen">
    <ItemGroup>
      <Compile Remove="$(IntermediateOutputPath)/SharpGen/**/*.cs" />
      <SharpGenGeneratedSource Include="$(IntermediateOutputPath)/SharpGen/**/*.cs" />
      <SharpGenConsumerBindMappingFile Include="$(MSBuildProjectDirectory)/$(IntermediateOutputPath)SharpGen/$(SharpGenConsumerBindMappingFilePrefix).BindMapping.xml" />
    </ItemGroup>
  </Target>

  <Target Name="GenerateSharpGenBindings"
    BeforeTargets="CoreCompile"
    DependsOnTargets="PrepareForBuild;CoreGenerateSharpGenBindings;GenerateConsumerBindMappingFile"
    />

  <Target Name="CoreGenerateSharpGenBindings" 
    BeforeTargets="CoreCompile"
    DependsOnTargets="PrepareForBuild;CorePrepareSharpGen"
    Inputs="@(SharpGenMapping)"
    Outputs="@(SharpGenConsumerBindMappingFile);@(SharpGenGeneratedSource)">

    <MakeDir Directories="$(IntermediateOutputPath)/SharpGen" />
    <SharpGenTask
      CastXmlPath="$(CastXmlPath)"
      AppTypes="$(SharpGenAppType)"
      GenerateDocs="$(SharpGenGenerateDoc)"
      GlobalNamespace="$(SharpGenGlobalNamespace)"
      VcToolsPath="$(VCToolsDir)"
      MappingFiles="@(SharpGenMapping)"
      IntermediateOutputPath="$(MSBuildProjectDirectory)\$(IntermediateOutputPath)SharpGen"
      GeneratedCodeFolder="$(SharpGenGeneratedCodeFolder)"
      IncludeAssemblyNameFolder="$(SharpGenIncludeAssemblyNameFolder)"
      OutputDirectory="$(MSBuildProjectDirectory)"
      ConsumerBindMappingFilePrefix="$(SharpGenConsumerBindMappingFilePrefix)"
      ConsumerBindMappingConfigId ="$(SharpGenConsumerBindMappingConfigId)"
    />

    <ItemGroup>
      <Compile Include="$(IntermediateOutputPath)/SharpGen/**/*.cs" />
    </ItemGroup>
  </Target>

  <Target Name="GenerateConsumerBindMappingFile"
    DependsOnTargets="CoreGenerateSharpGenBindings"
    Outputs="@(SharpGenConsumerBindMappingFile)"
  >
  </Target>
  
  <Target Name="CleanSharpGenBindings" BeforeTargets="Clean">
    <RemoveDir Directories="$(IntermediateOutputPath)/SharpGen" />
  </Target>
  
  <Target Name="PatchAssembly" AfterTargets="CopyFilesToOutputDirectory" BeforeTargets="IncrementalClean">
    <SharpPatchTask AssemblyToPatch="$(TargetPath)" References="@(ReferencePath)" />
  </Target>
</Project>